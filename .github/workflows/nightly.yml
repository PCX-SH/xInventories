name: Nightly Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  nightly:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew shadowJar

      - name: Get short SHA
        id: sha
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Get current date
        id: date
        run: echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Rename jar with build info
        run: |
          mv build/libs/xInventories-*.jar build/libs/xInventories-nightly-${{ steps.sha.outputs.SHORT_SHA }}.jar

      - name: Update Nightly Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: "Nightly Build"
          body: |
            ## üåô Nightly Build

            **Latest development build from main branch.**

            - **Commit:** ${{ github.sha }}
            - **Date:** ${{ steps.date.outputs.DATE }}
            - **Branch:** main

            ### ‚ö†Ô∏è Warning
            This is an automated development build and may be unstable.
            For stable releases, see the [latest release](https://github.com/PCX-SH/xInventories/releases/latest).

            ### Installation
            1. Download `xInventories-nightly-${{ steps.sha.outputs.SHORT_SHA }}.jar`
            2. Place in your server's `plugins/` folder
            3. Restart your server

            ### Requirements
            - **Paper 1.20.5+**
            - **Java 21+**
          files: build/libs/xInventories-nightly-*.jar
          prerelease: true
          make_latest: false
