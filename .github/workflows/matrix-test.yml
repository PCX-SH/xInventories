# Multi-version Paper compatibility testing
#
# This workflow tests xInventories against multiple Paper versions to ensure
# broad compatibility across the Minecraft ecosystem.
#
# Strategy matrix:
# - paper-version: [1.20.5, 1.20.6, 1.21, 1.21.1, 1.21.3, 1.21.4]
# - java-version: [21] (all versions require Java 21)
#
# Testing approach:
# 1. Build the plugin with Gradle
# 2. Run unit tests (MockBukkit v1.21 may have compatibility limits)
# 3. Use run-paper for smoke tests (start server, verify plugin loads)
#
# Note: MockBukkit 4.x is specifically built for 1.21, so integration tests
# may only pass on 1.21+ versions. Unit tests with MockK should work across
# all versions since they mock the Bukkit API.
#
# Trigger: on PR to main (not every push to avoid excessive CI runs)

name: Multi-Version Paper Testing

on:
  pull_request:
    branches: [ main ]
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  # Build job runs first to cache dependencies and verify compilation
  build:
    name: Build Plugin
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew shadowJar

      - name: Upload plugin JAR
        uses: actions/upload-artifact@v6
        with:
          name: plugin-jar
          path: build/libs/xInventories-*.jar
          retention-days: 1

  # Matrix test job - runs unit tests
  # MockBukkit 4.x targets 1.21, so full integration tests may only work there
  unit-tests:
    name: Unit Tests (Paper ${{ matrix.paper-version }})
    runs-on: ubuntu-latest
    needs: build

    strategy:
      # Don't fail fast - we want to see results for all versions
      fail-fast: false
      matrix:
        paper-version: ['1.20.5', '1.20.6', '1.21', '1.21.1', '1.21.3', '1.21.4']
        java-version: ['21']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Run tests - MockBukkit 4.x is for 1.21, so older versions may have
      # compatibility issues with integration tests. Unit tests using MockK
      # should still pass as they mock the API directly.
      - name: Run unit tests
        run: ./gradlew test
        # Allow experimental versions to fail without blocking the workflow
        # 1.20.x versions may fail MockBukkit integration tests
        continue-on-error: ${{ matrix.paper-version == '1.20.5' || matrix.paper-version == '1.20.6' }}

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-${{ matrix.paper-version }}
          path: build/reports/tests/
          retention-days: 7

  # Smoke test - verify plugin loads on actual Paper server
  # Uses xyz.jpenilla.run-paper to start a server and check plugin initialization
  smoke-test:
    name: Smoke Test (Paper ${{ matrix.paper-version }})
    runs-on: ubuntu-latest
    needs: build

    strategy:
      fail-fast: false
      matrix:
        # Test representative versions - not all to save CI time
        paper-version: ['1.20.6', '1.21.1', '1.21.4']
        java-version: ['21']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Download plugin JAR
        uses: actions/download-artifact@v7
        with:
          name: plugin-jar
          path: build/libs/

      # Accept EULA for Paper server
      - name: Accept Minecraft EULA
        run: |
          mkdir -p run
          echo "eula=true" > run/eula.txt

      # Run the server briefly to check plugin loads
      # The runServer task will download Paper and start the server
      # We use a timeout to stop it after a few seconds
      - name: Run smoke test for Paper ${{ matrix.paper-version }}
        run: |
          # Override the minecraft version for this test
          # Create a temporary gradle properties to override the version
          echo "Smoke testing with Paper ${{ matrix.paper-version }}"

          # Run the server with a timeout - if it starts and plugin loads, we're good
          # The server will be killed after 60 seconds
          timeout 60s ./gradlew runServer \
            -PminecraftVersion=${{ matrix.paper-version }} \
            --no-daemon \
            2>&1 | tee server.log || true

          # Check if plugin loaded successfully
          if grep -q "xInventories.*enabled" server.log || grep -q "\[xInventories\]" server.log; then
            echo "Plugin loaded successfully on Paper ${{ matrix.paper-version }}"
          else
            echo "Warning: Could not confirm plugin load for Paper ${{ matrix.paper-version }}"
            echo "This may be due to the server not fully starting in time"
          fi
        continue-on-error: true

      - name: Upload server log
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: server-log-${{ matrix.paper-version }}
          path: server.log
          retention-days: 3

  # Summary job that reports overall status
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [build, unit-tests, smoke-test]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## Multi-Version Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: 1.20.x versions may have MockBukkit compatibility issues." >> $GITHUB_STEP_SUMMARY
          echo "The plugin is compiled against Paper 1.21.1 API and should work on 1.20.5+." >> $GITHUB_STEP_SUMMARY
